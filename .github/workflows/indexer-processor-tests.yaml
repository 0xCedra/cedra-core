name: Trigger Processor Tests on JSON Change

on:
  workflow_dispatch:
  pull_request:  # Trigger on PR-level events
#    paths:
#      - 'indexer-test-transactions/json_transactions/imported_transactions/**'
#      - 'indexer-test-transactions/json_transactions/scripted_transactions/**'
    branches:
      - main

# Grant the required permissions to request the ID token
permissions:
  id-token: write  # This is required for GCP authentication
  contents: read   # Ensure the workflow has access to repository contents


jobs:
  dispatch_event:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3

      - id: auth
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Log active service account email
        run: |
          gcloud auth list --filter=status:ACTIVE --format="value(account)"

      - id: 'secrets'
        uses: 'google-github-actions/get-secretmanager-secrets@v2'
        with:
          secrets: |-
            token:1062980880927/github-actions-repository-dispatch

      - name: Dispatch Event to Processor Repo
        uses: peter-evans/repository-dispatch@v3.0.0
        with:
          TOKEN: '${{ steps.secrets.outputs.token }}'
          repository: 'aptos-labs/aptos-indexer-processors'
          event-type: 'json-change-detected'
          client-payload: '{"commit_hash": "${{ github.sha }}"}'

#jobs:
#  diff_check:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout the repository
#        uses: actions/checkout@v3
#
#      - name: Run CLI to Generate JSON Files
#        run: |
#          # Navigate to the directory and run the CLI
#          cd ecosystem/indexer-grpc/indexer-transaction-generator
#          cargo run -- --testing-folder ./example_tests --output-folder ../indexer-test-transactions/json_transactions
#        working-directory: rust
#
#      - name: Compare JSON Files
#        run: |
#          diff -qr generated_jsons/ indexer-test-transactions/json_transactions/
#        continue-on-error: true
#        id: diff_check
#
#      - name: Dispatch Event if Changes Found
#        if: steps.diff_check.outcome == 'failure'  # Only run if diff found changes
#        uses: peter-evans/repository-dispatch@v3.0.0
#        with:
#          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
#          repository: 'aptos-labs/aptos-indexer-processors'
#          event-type: 'json-change-detected'
#          client-payload: '{"commit_hash": "${{ github.sha }}"}'