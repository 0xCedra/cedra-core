// Copyright (c) Aptos
// SPDX-License-Identifier: Apache-2.0

syntax = "proto3";

package aptos.datastream.v1;

message TransactionsOutput {
  repeated TransactionOutput transactions  = 1;
}

message TransactionOutput {
  string encoded_proto_data = 1;
  uint64 version = 2;
}


/*
StreamStatus serves as the signal to inform the downstream about current
streaming status. It
  1. sends the INIT signal for the first time when connection starts.
    Only start_version is present.
  2. sends the BATCH_END signal for each batch ends. Both starting version(inclusive) and
    end version(exclusive) for the batch are present, i.e., [start_version, end_version).
*/
message StreamStatus {
  enum StatusType {
    INIT = 0;
    BATCH_END = 1;
  }
  StatusType type = 1;
  // Starting version of current stream/batch, inclusive.
  uint64 start_version = 2;
  // Ending version of current batch, exclusive.
  optional uint64 end_version = 3;
}

message RawDatastreamRequest {
  uint64 starting_version = 1;
  uint64 processor_task_count = 3;
  uint64 processor_batch_size = 2;
  uint64 output_batch_size = 4;
  uint32 chain_id = 5;
}

message RawDatastreamResponse {
  enum response_type {
    STATUS = 0;
    DATA = 1;
  }
  oneof response {
    StreamStatus status = 1;
    TransactionsOutput data = 2;
  }
}

service IndexerStream {
    rpc RawDatastream(RawDatastreamRequest) returns (stream RawDatastreamResponse);
}